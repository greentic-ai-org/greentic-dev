name: Release

on:
  # Branch pushes to master and manual dispatch:
  # - run CI (build/test)
  # - publish to crates.io
  push:
    branches:
      - master
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    name: CI (build/test) + Publish
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_NET_RETRY: "10"
      CARGO_HTTP_CHECK_REVOKE: "false"
      CARGO_HOME: ${{ github.workspace }}/.cargo-${{ github.job }}-${{ github.run_id }}
      CARGO_TARGET_DIR: ${{ github.workspace }}/.target-${{ github.job }}-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}
            ${{ env.CARGO_TARGET_DIR }}
          key: release-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Verify build (locked)
        run: |
          cargo fetch --locked
          cargo build --workspace --locked --all-features
          cargo test --workspace --locked --all-features -- --quiet

      - name: Cargo package (dry-run)
        run: cargo package --locked --allow-dirty --no-verify || true

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -eo pipefail
          if output=$(cargo publish --locked 2>&1); then
            printf "%s\n" "$output"
          else
            printf "%s\n" "$output"
            if printf "%s\n" "$output" | grep -qi "already exists on crates.io index"; then
              echo "crate version already published; skipping publish step."
              echo "crate version already on crates.io; no new publish performed."
            else
              exit 1
            fi
          fi
