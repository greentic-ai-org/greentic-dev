name: CI

on:
  push:
    branches: ["master", "main"]
  pull_request:

permissions:
  contents: read

jobs:
  rust-ci:
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      RUSTFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - uses: mozilla-actions/sccache-action@v0.0.4

      - name: Configure sccache
        run: echo 'RUSTC_WRAPPER=sccache' >> "$GITHUB_ENV"

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            ~/.cache/sccache
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: fmt
        run: cargo fmt --all --check

      - name: clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: test
        run: cargo test --all-features --locked

      - name: package smoke
        run: ./ci/package_smoke.sh

      - name: cargo-dist build (linux)
        run: |
          command -v dist >/dev/null 2>&1 || cargo install cargo-dist
          DIST_TAG=$(cargo metadata --no-deps --format-version=1 | python3 - <<'PY'
import json, sys
data = json.load(sys.stdin)
for pkg in data["packages"]:
    if pkg["name"] == "greentic-dev":
        print(f"v{pkg['version']}")
        break
else:
    raise SystemExit("greentic-dev package not found in metadata")
PY
)
          dist build --target x86_64-unknown-linux-gnu --no-local-paths --tag "${DIST_TAG}"
